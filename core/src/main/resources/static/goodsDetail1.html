<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>订单详情</title>
    <link href="https://fonts.googleapis.com/css2?family=Display+Playfair:wght@400;700&family=Inter:wght@400;700&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="fonts/index.css">
    <link rel="stylesheet" type="text/css" href="css/index_latest.css">
    <link rel="stylesheet" type="text/css" href="html/css/normalize.css"/>
    <link rel="stylesheet" type="text/css" href="html/css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="html/css/font-awesome/css/font-awesome.min.css"/>
    <link rel="stylesheet" type="text/css" href="html/elegant_font/style.css"/>
    <link rel="stylesheet" type="text/css" href="html/css/magnific-popup.css"/>
    <link rel="stylesheet" type="text/css" href="html/css/slider-pro.css"/>
    <link rel="stylesheet" type="text/css" href="html/css/owl.carousel.css"/>
    <link rel="stylesheet" type="text/css" href="html/css/owl.theme.css"/>
    <link rel="stylesheet" type="text/css" href="html/css/owl.transitions.css"/>
    <link rel="stylesheet" type="text/css" href="html/css/animate.css"/>
    <link rel="stylesheet" type="text/css" href="html/elegant_font/style.css"/>
    <link rel="stylesheet" type="text/css" href="html/css/style.css"/>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="html/elegant_font/lte-ie7.js"></script>
    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/vue.js"></script>
    <script src="html/js/jquery-1.11.3.min.js"></script>
    <script src="html/js/bootstrap.min.js"></script>
    <script src="html/js/modernizr.min.js"></script>
    <script src="html/js/jquery.easing.1.3.js"></script>
    <script src="html/js/jquery.scrollUp.min.js"></script>
    <script src="html/js/jquery.easypiechart.js"></script>
    <script src="html/js/isotope.pkgd.min.js"></script>
    <script src="html/js/jquery.fitvids.js"></script>
    <script src="html/js/jquery.stellar.min.js"></script>
    <script src="html/js/jquery.waypoints.min.js"></script>
    <script src="html/js/wow.min.js"></script>
    <script src="html/js/jquery.nav.js"></script>
    <script src="html/js/imagesloaded.pkgd.min.js"></script>
    <script src="html/js/smooth-scroll.min.js"></script>
    <script src="html/js/jquery.magnific-popup.min.js"></script>
    <script src="html/js/jquery.sliderPro.min.js"></script>
    <script src="html/js/owl.carousel.min.js"></script>
    <script src="html/js/custom.js"></script>
    <script src="js/common.js"></script>
    <!-- 使用layer弹窗 -->
    <script src="https://cdn.bootcdn.net/ajax/libs/layer/3.1.1/layer.js"></script>
    <style>
        .collapse {
            background-color: transparent;
        }
        .navbar-nav {
            font-size: 2em;
            font-weight: bolder;
            font-family: 微软雅黑;
            color: #1867d3;
        }
        .navbar-brand:hover {
            color: #1867d3;
        }

    </style>
</head>

<body id="all">
<header>
     <nav id="topNav" class="navbar navbar-default main-menu">
        <div  class="container">
            <button class="navbar-toggler hidden-md-up pull-right" type="button" data-toggle="collapse"
                    data-target="#collapsingNavbar">
                ☰
            </button>
            <a class="navbar-brand page-scroll" style="font-family: 微软雅黑;color: black">电商秒杀系统</a>
            <div class="collapse navbar-toggleable-sm" id="collapsingNavbar">
                <ul class="nav navbar-nav" style="font-size: 30px">
                    <li>
                        <a href="#" id="username" style="color: #0b0b0b">用户名</a>
                    </li>
                    <li>
                    <li>
                        <div class="nav-item dropdown no-arrow">
                            <a class="dropdown-toggle nav-link " data-toggle="dropdown" aria-expanded="false"
                               href="#"><span class="d-none d-lg-inline mr-2 text-gray-600" style="color: #0b0b0b;text-transform: none" id="userNameLogin">Settings</span></a>
                            <div class="dropdown-menu shadow dropdown-menu-right animated--grow-in"
                                 style="background: white;border-radius: 13px;">
                                <a class="dropdown-item" href="adminInfo.html" style="color: #222265">个人主页</a>
                                <a class="dropdown-item" href="secretEdit_admin.html" style="color: #222265">修改密码</a>
                            </div>
                        </div>
                    </li>
                    </li>
                    <li>
                        <a href="#" id="logout" style="color: #0b0b0b">退出登录</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>
<section id="services" class="section-wrapper">
    <div class="container">
        <div class="row">
            <div class="our-services">
                <div class="untree_co-section" style="color: #0a53be">
                    <div class="container">
                        <div class="row" style="width: 80%;margin-left: 3rem">
                            <div style="margin-left: 17%" class="col-md-4 col-sm-4 col-xs-12 text-xs-center wow fadeInDown" data-wow-delay=".2s">
                                <div class="service-box" style="padding: 6px;margin-bottom: 128px;margin-left: -70px">
                                    <img id="pic" width="300" height="300">
                                    <div>
                                        <span id="sp" class="h5"></span>
                                    </div>
                                </div>
                            </div>
                            <form action="#" class="form-box" style="width: 200%;margin-left: -100%">
                                <div class="row" id="content">
                                    <ul id="tx1" class="h5" ></ul>
                                    <ul id="tx2" style="color: #be0a34" class="h5"></ul>
                                    <span id="tx3" style="color: #be0a34" class="h5"></span>
                                    <div class="col-12 text-center" style="margin-top: 5%">
                                        <input id="buyButton" type="button" value="开始秒杀" class="btn btn-primary btn-lg fs-5">
                                    </div>
                                </div>
                            </form>
                        </div>
                        </div>
                    </div>
                </div>
        </div>
    </div>
</section>
<script>
    $(function () {
        console.log("参数为"+g_getQueryString("seckillid"))
        var seckillId = g_getQueryString("seckillid");
        layer.load();
        $.ajax({
            url: `http://localhost:8083/goods/gdetail?seckillid=${seckillId}`,
            type: "GET",
            contentType: "application/json;charset=utf-8",
            success: function(data) {
                console.log(data)
                layer.closeAll();
                if (data.returnNo.code == 200) {
                    $("#pic").attr("src",'/goodsimg/'+data.data.img)
                    $("#sp").text(data.data.title)
                    $("#tx1").text("原价为："+data.data.price)
                    $("#tx2").text("秒杀价为："+data.data.seckillPrice)
                    $("#tx3").text("秒杀还剩余："+data.data.seckillStock)
                    layer.msg("跳转成功");
                }else {
                    layer.msg(data.returnNo.message+"\n更详细的信息:"+data.specMessage);
                }
            },
            error: function(data) {
                layer.closeAll();
                data = JSON.parse(data.responseText);
                layer.msg(data.data.join(','));
            }
        });
        $("#buyButton").click(function() {
            $.ajax({
                url: `http://localhost:8084/seckill/${seckillId}`,
                xhrFields: {
                    withCredentials: true //默认情况下，标准的跨域请求是不会发送cookie的
                },
                type: "POST",
                contentType: "application/json;charset=utf-8",
                success: function(data) {
                    console.log(data);
                    // layer.closeAll();
                    if (data.returnNo.code == 705) {
                        // layer.msg("正在秒杀");
                        console.log(data)
                        getResult(seckillId, true)
                        // window.location.href = "orderDetail1.html?orderId="+data.data;
                    }else if(data.returnNo.code == 703) {
                        layer.confirm("您已经抢购过该类商品,是否查看订单",{btn:["确定", "取消"]},
                            function () {
                                getResult(seckillId, false);
                            },
                            function() {
                                layer.close();
                            })
                    } else {
                        console.log(data)
                        layer.msg(data.returnNo.message+"\n");
                    }
                },
                error: function(data) {
                    layer.closeAll();
                    data = JSON.parse(data.responseText);
                    layer.msg(data.data);
                }
            });
        })

    })
    function getResult(seckillId, flag){
        console.log("请求中"+seckillId)
        g_showLoading();
        console.log(flag);
        $.ajax({
            url: `http://localhost:8085/order/result/${seckillId}`,
            type: "GET",
            xhrFields: {
                withCredentials: true //默认情况下，标准的跨域请求是不会发送cookie的
            },
            success: function(data) {
                if (data.returnNo.code == 200) {
                    console.log(data)
                    if (data.data<0){
                        layer.msg("对不起，没抢到")
                    }else if (data.data==0){
                        setTimeout(function () {
                            getResult(seckillId, flag)
                        },1000)
                    }else{
                        console.log(flag);
                        if (flag) {
                            layer.confirm("秒杀成功,是否查看订单", {btn: ["确定", "取消"]},
                                function () {
                                    window.location.href = "orderDetail1.html?orderId=" + data.data;
                                },
                                function () {
                                    layer.close();
                                })
                        }else {

                            window.location.href = "orderDetail1.html?orderId=" + data.data;
                        }
                    }
                }else {
                    layer.msg(data.returnNo.message+"\n更详细的信息:"+data.specMessage);
                }
            },
            error: function(data) {
                layer.msg("客户端请求错误");
            }
        });
    }

</script>
</body>
</html>